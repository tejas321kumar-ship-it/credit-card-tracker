<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="description" content="Track your credit card spending and transactions securely">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.svg">
    <title>Login - Card Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div id="auth-container">
        <div class="auth-card glass">
            <a href="/" class="back-to-home"
                style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-muted); text-decoration: none; margin-bottom: 1.5rem; font-size: 0.9rem;">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                Back to Home
            </a>
            <div class="auth-header">
                <i data-lucide="credit-card" class="auth-icon"></i>
                <h1>Card Tracker</h1>
                <p>Secure card & transaction management</p>
            </div>

            <div id="login-form-container">
                <form id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-wrapper">
                            <input type="password" name="password" required placeholder="••••••••" minlength="6"
                                id="login-password">
                            <button type="button" class="password-toggle"
                                onclick="togglePassword('login-password', this)">
                                <i data-lucide="eye" style="width: 18px; height: 18px;"></i>
                            </button>
                        </div>
                    </div>
                    <div class="remember-me"
                        style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="checkbox" id="rememberMe" name="rememberMe"
                            style="width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer;">
                        <label for="rememberMe"
                            style="cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; user-select: none;">Remember
                            me</label>
                    </div>
                    <div id="login-error" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn-submit" style="width: 100%; padding: 1rem;">Login</button>
                </form>

                <!-- Social Login -->
                <div class="social-divider">
                    <span>or continue with</span>
                </div>
                <div class="social-buttons">
                    <button class="social-btn" onclick="alert('Google login coming soon!')">
                        <svg width="18" height="18" viewBox="0 0 48 48">
                            <path fill="#EA4335"
                                d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                            <path fill="#4285F4"
                                d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                            <path fill="#FBBC05"
                                d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
                            <path fill="#34A853"
                                d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                        </svg>
                        Google
                    </button>
                    <button class="social-btn" onclick="alert('GitHub login coming soon!')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                        </svg>
                        GitHub
                    </button>
                </div>

                <!-- Demo Hint -->
                <div class="demo-hint">
                    <i data-lucide="info" style="width: 14px; height: 14px; flex-shrink: 0;"></i>
                    <span>Demo: <strong>demo@example.com</strong> / <strong>demo123</strong></span>
                </div>

                <p class="auth-switch">Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
            </div>

            <div id="register-form-container" style="display: none;">
                <form id="register-form">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="name" required placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-wrapper">
                            <input type="password" name="password" required placeholder="••••••••" minlength="6"
                                id="register-password" oninput="updatePasswordStrength(this.value)">
                            <button type="button" class="password-toggle"
                                onclick="togglePassword('register-password', this)">
                                <i data-lucide="eye" style="width: 18px; height: 18px;"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="strength-bar" id="strength-bar"></div>
                        </div>
                        <small class="strength-label" id="strength-label"></small>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <div class="password-wrapper">
                            <input type="password" name="confirmPassword" required placeholder="••••••••" minlength="6"
                                id="register-confirm">
                            <button type="button" class="password-toggle"
                                onclick="togglePassword('register-confirm', this)">
                                <i data-lucide="eye" style="width: 18px; height: 18px;"></i>
                            </button>
                        </div>
                    </div>
                    <div id="register-error" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn-submit" style="width: 100%; padding: 1rem;">Create Account</button>
                </form>
                <p class="auth-switch">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Animated Background Shapes -->
    <div class="bg-shape bg-shape-1"></div>
    <div class="bg-shape bg-shape-2"></div>
    <div class="bg-shape bg-shape-3"></div>

    <style>
        #auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        /* Animated Background Shapes */
        .bg-shape {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            pointer-events: none;
            animation: floatShape 20s ease-in-out infinite;
        }

        .bg-shape-1 {
            width: 400px;
            height: 400px;
            background: #6366f1;
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        .bg-shape-2 {
            width: 300px;
            height: 300px;
            background: #8b5cf6;
            bottom: -50px;
            right: -50px;
            animation-delay: -7s;
        }

        .bg-shape-3 {
            width: 200px;
            height: 200px;
            background: #a855f7;
            top: 50%;
            left: 50%;
            animation-delay: -14s;
        }

        @keyframes floatShape {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(30px, -30px) scale(1.1);
            }

            50% {
                transform: translate(-20px, 20px) scale(0.95);
            }

            75% {
                transform: translate(15px, 10px) scale(1.05);
            }
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-icon {
            width: 60px;
            height: 60px;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .auth-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: var(--gradient-main);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Password Wrapper */
        .password-wrapper {
            position: relative;
        }

        .password-wrapper input {
            padding-right: 3rem !important;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
        }

        .password-toggle:hover {
            color: var(--accent);
        }

        /* Password Strength */
        .password-strength {
            height: 4px;
            background: var(--border);
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
        }

        .strength-label {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Social Login */
        .social-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .social-divider::before,
        .social-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .social-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-main);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .social-btn:hover {
            border-color: var(--accent);
            background: var(--bg-card-hover);
            transform: translateY(-1px);
        }

        /* Demo Hint */
        .demo-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.6rem 0.75rem;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .demo-hint strong {
            color: var(--accent);
        }

        /* Input Focus Glow */
        .form-group input:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }
    </style>

    <script>
        // Try auto-login with stored token first
        async function tryAutoLogin() {
            const rememberToken = localStorage.getItem('rememberToken');
            if (rememberToken) {
                try {
                    const res = await fetch('/api/auto-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rememberToken })
                    });
                    if (res.ok) {
                        window.location.href = '/dashboard.html';
                        return true;
                    } else {
                        // Token invalid/expired, remove it
                        localStorage.removeItem('rememberToken');
                    }
                } catch (err) {
                    console.error('Auto-login error:', err);
                }
            }
            return false;
        }

        // Check if already logged in via session or token
        (async () => {
            // First check session
            try {
                const res = await fetch('/api/me');
                if (res.ok) {
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (e) { }

            // Try auto-login with token
            await tryAutoLogin();
        })();

        function showLogin() {
            document.getElementById('login-form-container').style.display = 'block';
            document.getElementById('register-form-container').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('register-form-container').style.display = 'block';
        }

        // Load saved email on page load
        const savedEmail = localStorage.getItem('rememberedEmail');
        if (savedEmail) {
            document.querySelector('#login-form input[name="email"]').value = savedEmail;
            document.getElementById('rememberMe').checked = true;
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const errorDiv = document.getElementById('login-error');
            const rememberMe = document.getElementById('rememberMe').checked;

            // Save or remove email based on Remember Me checkbox
            if (rememberMe) {
                localStorage.setItem('rememberedEmail', data.email);
            } else {
                localStorage.removeItem('rememberedEmail');
                localStorage.removeItem('rememberToken');
            }

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...data, rememberMe })
                });
                const result = await res.json();

                if (res.ok) {
                    // Save remember token if provided
                    if (result.rememberToken) {
                        localStorage.setItem('rememberToken', result.rememberToken);
                    }
                    // Save new CSRF token from regenerated session
                    if (result.csrfToken) {
                        sessionStorage.setItem('csrfToken', result.csrfToken);
                    }
                    window.location.href = '/dashboard.html';
                } else {
                    errorDiv.textContent = result.error || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const errorDiv = document.getElementById('register-error');

            if (data.password !== data.confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (res.ok) {
                    window.location.href = '/dashboard.html';
                } else {
                    errorDiv.textContent = result.error || 'Registration failed';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.style.display = 'block';
            }
        });

        // Toggle password visibility
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            if (window.lucide) lucide.createIcons();
        }

        // Password strength indicator
        function updatePasswordStrength(password) {
            const bar = document.getElementById('strength-bar');
            const label = document.getElementById('strength-label');
            if (!bar || !label) return;

            let score = 0;
            if (password.length >= 6) score++;
            if (password.length >= 10) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            const levels = [
                { width: '0%', color: 'transparent', text: '' },
                { width: '20%', color: '#ef4444', text: 'Very weak' },
                { width: '40%', color: '#f59e0b', text: 'Weak' },
                { width: '60%', color: '#eab308', text: 'Fair' },
                { width: '80%', color: '#22c55e', text: 'Strong' },
                { width: '100%', color: '#10b981', text: 'Very strong' }
            ];

            const level = levels[score];
            bar.style.width = level.width;
            bar.style.background = level.color;
            label.textContent = level.text;
            label.style.color = level.color;
        }

        if (window.lucide) lucide.createIcons();
    </script>
</body>

</html>